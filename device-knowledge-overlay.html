<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #0f1117;
      color: #e0e0e0;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      user-select: none;
    }

    .titlebar {
      -webkit-app-region: drag;
      height: 38px;
      background: #0a0c10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px 0 80px;
      flex-shrink: 0;
      border-bottom: 1px solid #1e2130;
    }

    .titlebar-title {
      font-size: 12px;
      font-weight: 600;
      color: #8b8fa8;
      letter-spacing: 0.5px;
    }

    .titlebar-close {
      -webkit-app-region: no-drag;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: none;
      background: #2a2d3a;
      color: #666;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }
    .titlebar-close:hover { background: #ff4757; color: white; }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 18px 18px 12px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .section-label {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: #5a5f78;
      margin-bottom: 6px;
    }

    .app-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
    }

    .app-chip {
      padding: 5px 12px;
      border-radius: 20px;
      border: 1px solid #2a2d3a;
      background: #161820;
      color: #8b8fa8;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .app-chip:hover { border-color: #6c63ff; color: #a09aff; }
    .app-chip.active { border-color: #6c63ff; background: #1e1a3a; color: #a09aff; font-weight: 600; }

    .text-area-wrap {
      position: relative;
    }

    textarea {
      width: 100%;
      min-height: 130px;
      background: #161820;
      border: 1px solid #2a2d3a;
      border-radius: 10px;
      color: #e0e0e0;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
      font-size: 13px;
      line-height: 1.55;
      padding: 12px 14px;
      resize: vertical;
      outline: none;
      transition: border-color 0.15s;
    }
    textarea:focus { border-color: #6c63ff; }
    textarea::placeholder { color: #3a3d50; }

    .char-count {
      position: absolute;
      bottom: 8px;
      right: 10px;
      font-size: 10px;
      color: #3a3d50;
    }

    .screenshot-row {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .btn-screenshot {
      flex-shrink: 0;
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid #2a2d3a;
      background: #161820;
      color: #8b8fa8;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .btn-screenshot:hover { border-color: #4ecdc4; color: #4ecdc4; }
    .btn-screenshot.captured { border-color: #4ecdc4; color: #4ecdc4; background: #0e2420; }

    .screenshot-preview {
      flex: 1;
      height: 60px;
      border-radius: 8px;
      border: 1px solid #2a2d3a;
      background: #161820;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .screenshot-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0.7;
    }
    .screenshot-preview .placeholder-text {
      font-size: 10px;
      color: #3a3d50;
    }

    .btn-submit {
      width: 100%;
      padding: 13px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, #6c63ff, #5a52e0);
      color: white;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      letter-spacing: 0.3px;
    }
    .btn-submit:hover { background: linear-gradient(135deg, #7c74ff, #6a62f0); transform: translateY(-1px); }
    .btn-submit:active { transform: translateY(0); }
    .btn-submit:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .loading-bar {
      width: 100%;
      height: 2px;
      background: #1e2130;
      border-radius: 2px;
      overflow: hidden;
      display: none;
    }
    .loading-bar.active { display: block; }
    .loading-bar-inner {
      height: 100%;
      background: linear-gradient(90deg, #6c63ff, #4ecdc4, #6c63ff);
      background-size: 200% 100%;
      animation: shimmer 1.2s ease-in-out infinite;
      width: 100%;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .result-panel {
      background: #0d1a14;
      border: 1px solid #1a3a28;
      border-radius: 10px;
      padding: 14px;
      display: none;
    }
    .result-panel.visible { display: block; }

    .result-header {
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: #34d399;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .learned-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #1a2e20;
    }
    .learned-item:last-child { border-bottom: none; padding-bottom: 0; }

    .learned-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #34d399;
      flex-shrink: 0;
      margin-top: 4px;
    }

    .learned-konzept {
      font-size: 11px;
      font-weight: 600;
      color: #a0f0cc;
      margin-bottom: 2px;
    }
    .learned-desc {
      font-size: 11px;
      color: #5a8a6a;
    }

    .error-panel {
      background: #1a0d0d;
      border: 1px solid #3a1a1a;
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 12px;
      color: #ff6b6b;
      display: none;
    }
    .error-panel.visible { display: block; }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #2a2d3a; border-radius: 2px; }
  </style>
</head>
<body>

<div class="titlebar">
  <span class="titlebar-title">Mira beibringen</span>
  <button class="titlebar-close" onclick="closeOverlay()">‚úï</button>
</div>

<div class="content">

  <!-- App ausw√§hlen -->
  <div>
    <div class="section-label">App / Kontext</div>
    <div class="app-selector" id="app-chips">
      <div class="app-chip active" data-app="Allgemein">Allgemein</div>
      <div class="app-chip" data-app="Word">Word</div>
      <div class="app-chip" data-app="Excel">Excel</div>
      <div class="app-chip" data-app="Outlook">Outlook</div>
      <div class="app-chip" data-app="Chrome">Chrome</div>
      <div class="app-chip" data-app="Finder">Finder</div>
      <div class="app-chip" data-app="Teams">Teams</div>
      <div class="app-chip" data-app="Sonstiges">Sonstiges</div>
    </div>
  </div>

  <!-- Freitext -->
  <div>
    <div class="section-label">Was soll Mira wissen?</div>
    <div class="text-area-wrap">
      <textarea id="knowledge-text"
        placeholder="z.B. Der Fett-Button ist in der Home-Toolbar oben links. Neue Seite √∂ffnen: Datei ‚Üí Neu. Tabelle einf√ºgen: Einf√ºgen ‚Üí Tabelle. Speichern: Cmd+S."
        oninput="updateCharCount()"
        maxlength="1000"></textarea>
      <span class="char-count" id="char-count">0 / 1000</span>
    </div>
  </div>

  <!-- Screenshot -->
  <div>
    <div class="section-label">Aktueller Bildschirm (optional)</div>
    <div class="screenshot-row">
      <button class="btn-screenshot" id="sc-btn" onclick="captureScreenshot()">
        <span>üì∏</span> Screenshot hinzuf√ºgen
      </button>
      <div class="screenshot-preview" id="sc-preview">
        <span class="placeholder-text">Kein Screenshot</span>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-bar" id="loading-bar">
    <div class="loading-bar-inner"></div>
  </div>

  <!-- Submit -->
  <button class="btn-submit" id="submit-btn" onclick="submitKnowledge()">
    Mira beibringen ‚ú¶
  </button>

  <!-- Ergebnis -->
  <div class="result-panel" id="result-panel">
    <div class="result-header">‚ú¶ Mira hat gelernt</div>
    <div id="learned-list"></div>
  </div>

  <!-- Fehler -->
  <div class="error-panel" id="error-panel"></div>

</div>

<script>
  const { ipcRenderer } = require('electron');

  let selectedApp = 'Allgemein';
  let capturedScreenshot = null;
  let capturedAX = null;

  // App-Chip Auswahl
  document.getElementById('app-chips').addEventListener('click', (e) => {
    const chip = e.target.closest('.app-chip');
    if (!chip) return;
    document.querySelectorAll('.app-chip').forEach(c => c.classList.remove('active'));
    chip.classList.add('active');
    selectedApp = chip.dataset.app;
  });

  function updateCharCount() {
    const len = document.getElementById('knowledge-text').value.length;
    document.getElementById('char-count').textContent = `${len} / 1000`;
  }

  async function captureScreenshot() {
    const btn = document.getElementById('sc-btn');
    btn.disabled = true;
    btn.innerHTML = '<span>‚è≥</span> Wird aufgenommen...';
    try {
      const result = await ipcRenderer.invoke('device-knowledge-screenshot');
      capturedScreenshot = result.screenshot;
      capturedAX = result.ax_state;
      btn.classList.add('captured');
      btn.innerHTML = '<span>‚úì</span> Screenshot gespeichert';
      const preview = document.getElementById('sc-preview');
      preview.innerHTML = `<img src="data:image/jpeg;base64,${capturedScreenshot}" alt="screenshot">`;
    } catch(e) {
      btn.innerHTML = '<span>üì∏</span> Screenshot hinzuf√ºgen';
    }
    btn.disabled = false;
  }

  async function submitKnowledge() {
    const text = document.getElementById('knowledge-text').value.trim();
    if (!text) {
      showError('Bitte beschreibe was Mira lernen soll.');
      return;
    }

    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.textContent = 'Mira lernt...';
    document.getElementById('loading-bar').classList.add('active');
    document.getElementById('result-panel').classList.remove('visible');
    document.getElementById('error-panel').classList.remove('visible');

    try {
      const result = await ipcRenderer.invoke('device-knowledge-save', {
        app_name: selectedApp,
        text,
        screenshot: capturedScreenshot,
        ax_state: capturedAX
      });

      if (result.success && result.learned?.length > 0) {
        showResult(result.learned);
        document.getElementById('knowledge-text').value = '';
        updateCharCount();
        capturedScreenshot = null;
        capturedAX = null;
        const scBtn = document.getElementById('sc-btn');
        scBtn.classList.remove('captured');
        scBtn.innerHTML = '<span>üì∏</span> Screenshot hinzuf√ºgen';
        document.getElementById('sc-preview').innerHTML = '<span class="placeholder-text">Kein Screenshot</span>';
      } else if (result.success) {
        showResult([{ konzept: 'Allgemein', beschreibung: 'Wissen gespeichert' }]);
      } else {
        showError(result.error || 'Unbekannter Fehler');
      }
    } catch(e) {
      showError('Verbindungsfehler: ' + e.message);
    }

    document.getElementById('loading-bar').classList.remove('active');
    btn.disabled = false;
    btn.textContent = 'Mira beibringen ‚ú¶';
  }

  function showResult(learned) {
    const list = document.getElementById('learned-list');
    list.innerHTML = learned.map(item => `
      <div class="learned-item">
        <div class="learned-dot"></div>
        <div>
          <div class="learned-konzept">${item.konzept} ${item.methode ? '¬∑ ' + item.methode : ''}</div>
          <div class="learned-desc">${item.beschreibung || ''}</div>
        </div>
      </div>
    `).join('');
    document.getElementById('result-panel').classList.add('visible');
  }

  function showError(msg) {
    const p = document.getElementById('error-panel');
    p.textContent = '‚ö† ' + msg;
    p.classList.add('visible');
  }

  function closeOverlay() {
    ipcRenderer.invoke('device-knowledge-close');
  }
</script>

</body>
</html>
