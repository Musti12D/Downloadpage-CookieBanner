<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>MIRA Route</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; background: rgba(0,0,0,0.18); width: 100vw; height: 100vh; overflow: hidden; -webkit-font-smoothing: antialiased; pointer-events: none; }
    #panel { position: fixed; top: 24px; left: 24px; width: 290px; background: rgba(8,8,8,0.97); border: 1px solid rgba(255,255,255,0.1); cursor: default; border-radius: 18px; overflow: hidden; box-shadow: 0 24px 60px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.04); pointer-events: all; }

    .panel-header { padding: 13px 15px; background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; align-items: center; gap: 9px; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.15} }
    .rec-dot { width: 7px; height: 7px; border-radius: 50%; background: #ff453a; animation: pulse 1.1s infinite; flex-shrink: 0; }
    .header-info { flex: 1; min-width: 0; }
    .header-title { font-size: 12px; font-weight: 700; color: #fff; }
    .header-name { font-size: 10px; color: rgba(255,255,255,0.3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 1px; font-family: 'DM Mono', monospace; }
    .dots-row { padding: 10px 15px 8px; display: flex; gap: 3px; flex-wrap: wrap; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .dot { width: 14px; height: 3px; border-radius: 2px; background: rgba(255,255,255,0.08); transition: all 0.3s; }
    .dot.done   { background: #34c759; }
    .dot.active { background: #ffd60a; transform: scaleY(2.5); }
    .dot.save   { background: rgba(255,69,58,0.5); }
    .instruction { padding: 14px 15px 12px; }
    .instr-step { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: rgba(255,255,255,0.2); margin-bottom: 6px; font-family: 'DM Mono', monospace; }
    .instr-main { font-size: 14px; font-weight: 700; color: #fff; letter-spacing: -0.3px; line-height: 1.3; margin-bottom: 5px; }
    .instr-sub  { font-size: 11px; color: rgba(255,255,255,0.38); line-height: 1.5; }
    .kb { display: inline-block; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.14); border-radius: 4px; padding: 0px 6px; font-family: 'DM Mono', monospace; font-size: 11px; font-weight: 600; color: #fff; }
    .kb.g { background: rgba(52,199,89,0.12);  border-color: rgba(52,199,89,0.3);  color: #34c759; }
    .kb.r { background: rgba(255,69,58,0.12);  border-color: rgba(255,69,58,0.3);  color: #ff453a; }
    .kb.y { background: rgba(255,214,10,0.12); border-color: rgba(255,214,10,0.3); color: #ffd60a; }
    #cmd-panel { display: none; border-top: 1px solid rgba(255,255,255,0.07); padding: 13px 15px 14px; background: rgba(255,255,255,0.02); }
    #cmd-panel.show { display: block; }
    .cmd-lbl { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: rgba(255,255,255,0.2); margin-bottom: 9px; font-family: 'DM Mono', monospace; }
    .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 9px; }
    .type-btn { padding: 7px 5px; border-radius: 7px; border: 1px solid rgba(255,255,255,0.07); background: transparent; color: rgba(255,255,255,0.3); font-size: 10px; font-weight: 600; cursor: pointer; font-family: 'DM Sans', sans-serif; text-align: center; transition: all 0.12s; }
    .type-btn:hover { border-color: rgba(255,255,255,0.2); color: rgba(255,255,255,0.7); }
    .t-click   { background: rgba(52,199,89,0.1);  border-color: rgba(52,199,89,0.3);  color: #34c759; }
    .t-type    { background: rgba(10,132,255,0.1); border-color: rgba(10,132,255,0.3); color: #0a84ff; }
    .t-extract { background: rgba(255,214,10,0.1); border-color: rgba(255,214,10,0.3); color: #ffd60a; }
    .t-url     { background: rgba(191,90,242,0.1); border-color: rgba(191,90,242,0.3); color: #bf5af2; }
    .t-key     { background: rgba(255,159,10,0.1); border-color: rgba(255,159,10,0.3); color: #ff9f0a; }
    .t-mark    { background: rgba(255,55,95,0.1);  border-color: rgba(255,55,95,0.3);  color: #ff375f; }
    .key-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 9px; }
    .key-btn { padding: 8px 5px; border-radius: 7px; border: 1px solid rgba(255,255,255,0.07); background: rgba(255,255,255,0.04); color: rgba(255,255,255,0.5); font-size: 11px; font-weight: 700; cursor: pointer; font-family: "DM Mono", monospace; text-align: center; transition: all 0.12s; }
    .key-btn:hover { border-color: rgba(255,159,10,0.4); color: #ff9f0a; }
    .key-btn.selected { border-color: rgba(255,159,10,0.6); color: #ff9f0a; background: rgba(255,159,10,0.15); }
    .cmd-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.09); border-radius: 8px; padding: 9px 11px; font-size: 12px; color: #fff; font-family: 'DM Sans', sans-serif; resize: none; transition: border-color 0.2s; margin-bottom: 7px; }
    .cmd-input:focus { outline: none; border-color: rgba(255,255,255,0.22); }
    .cmd-input::placeholder { color: rgba(255,255,255,0.16); font-size: 11px; }
    .cmd-hint { font-size: 10px; color: rgba(255,255,255,0.18); line-height: 1.5; margin-bottom: 9px; padding: 6px 9px; background: rgba(255,255,255,0.02); border-radius: 6px; }
    .mark-hint { font-size: 10px; color: #ff375f; padding: 5px 9px; margin-bottom: 7px; background: rgba(255,55,95,0.06); border-radius: 6px; border: 1px solid rgba(255,55,95,0.2); display: none; }
    #mark-start-btn { display: none; width: 100%; padding: 8px; border-radius: 7px; border: 1px solid rgba(255,55,95,0.4); background: rgba(255,55,95,0.1); color: #ff375f; font-size: 11px; font-weight: 700; cursor: pointer; margin-bottom: 7px; font-family: 'DM Sans', sans-serif; }
    #mark-start-btn:hover { background: rgba(255,55,95,0.2); }
    .cmd-row { display: flex; gap: 5px; }
    .cmd-btn { flex: 1; padding: 9px; border-radius: 7px; border: none; font-size: 11px; font-weight: 700; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.12s; }
    .cmd-btn:hover { opacity: 0.85; }
    .btn-save { background: #34c759; color: #000; }
    .btn-skip { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.45); }
    .bottom-row { padding: 8px 15px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; gap: 5px; }
    .bot-btn { flex: 1; padding: 8px; border-radius: 7px; font-size: 10px; font-weight: 700; cursor: pointer; font-family: 'DM Sans', sans-serif; transition: all 0.12s; }
    .bot-btn:hover { opacity: 0.8; }
    .bot-save   { background: rgba(52,199,89,0.12); border: 1px solid rgba(52,199,89,0.25); color: #34c759; }
    .bot-cancel { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); color: rgba(255,255,255,0.3); }
    #btn-weiter { display: none; width: calc(100% - 30px); margin: 0 15px 10px; padding: 9px; border-radius: 8px; border: 1px solid rgba(52,199,89,0.4); background: rgba(52,199,89,0.1); color: #34c759; font-size: 11px; font-weight: 700; cursor: pointer; font-family: 'DM Sans', sans-serif; text-align: center; }
    #btn-weiter:hover { background: rgba(52,199,89,0.2); }
    #done-block { display: none; padding: 20px 15px; text-align: center; }
    #done-block.show { display: block; }
    .done-icon  { font-size: 28px; margin-bottom: 8px; }
    .done-title { font-size: 13px; font-weight: 700; color: #fff; margin-bottom: 3px; }
    .done-sub   { font-size: 10px; color: rgba(255,255,255,0.3); }
    @keyframes flashIn { 0%{opacity:0} 20%{opacity:1} 80%{opacity:1} 100%{opacity:0} }
    #flash { position: fixed; inset: 0; background: rgba(52,199,89,0.06); pointer-events: none; opacity: 0; }
    #flash.show { animation: flashIn 0.35s ease forwards; }
    #mark-overlay { position: fixed; inset: 0; cursor: crosshair; z-index: 9999; display: none; pointer-events: all; background: rgba(0,0,0,0.01); }
    #mark-rect    { position: fixed; border: 2px solid #ff375f; background: rgba(255,55,95,0.08); pointer-events: none; display: none; z-index: 99998; }
  </style>
</head>
<body>

<div id="panel"
  onmouseenter="ipcRenderer.send('overlay-release-mouse')"
  onmouseleave="ipcRenderer.send('overlay-needs-mouse')"
>
  <div class="panel-header">
    <div class="rec-dot"></div>
    <div class="header-info">
      <div class="header-title">MIRA ¬∑ Aufnahme</div>
      <div class="header-name" id="route-name">‚Äî</div>
    </div>
  </div>
  <div class="dots-row" id="dots-row">
    <div class="dot active" id="dot-0"></div>
    <div class="dot" id="dot-1"></div>
    <div class="dot" id="dot-2"></div>
    <div class="dot" id="dot-3"></div>
    <div class="dot" id="dot-4"></div>
    <div class="dot" id="dot-5"></div>
    <div class="dot" id="dot-6"></div>
    <div class="dot" id="dot-7"></div>
    <div class="dot" id="dot-8"></div>
    <div class="dot save" id="dot-save"></div>
  </div>
  <div class="instruction" id="instr-block">
    <div class="instr-step" id="instr-step">START</div>
    <div class="instr-main" id="instr-main">Gehe auf den Desktop</div>
    <div class="instr-sub"  id="instr-sub">Minimiere alle Fenster ‚Üí <span class="kb y">0</span></div>
  </div>
  <button id="btn-weiter" onclick="weiterSteps()">‚ûï Weitere Steps aufnehmen (1-8 nochmal)</button>
  <div id="cmd-panel">
    <div class="cmd-lbl">Was soll MIRA hier tun?</div>
    <div class="type-grid">
      <button class="type-btn t-click"  id="type-click"   onclick="selType('click')">üñ± Klicken</button>
      <button class="type-btn"          id="type-type"    onclick="selType('type')">‚å®Ô∏è Tippen</button>
      <button class="type-btn"          id="type-extract" onclick="selType('extract')">üîç Extrahieren</button>
      <button class="type-btn"          id="type-url"     onclick="selType('url')">üåê URL</button>
      <button class="type-btn"          id="type-key"     onclick="selType('key')">‚Üµ Taste</button>
      <button class="type-btn"          id="type-mark"    onclick="selType('mark')">‚¨ö Markieren</button>
    </div>
    <textarea class="cmd-input" id="cmd-input" rows="2" placeholder="Optional: was MIRA hier tun soll..."></textarea>
    <div class="key-grid" id="key-grid" style="display:none">
      <button class="key-btn" onclick="selKey('enter', event)">‚Üµ Enter</button>
      <button class="key-btn" onclick="selKey('tab', event)">‚á• Tab</button>
      <button class="key-btn" onclick="selKey('escape', event)">‚éã Escape</button>
      <button class="key-btn" onclick="selKey('backspace', event)">‚å´ Backspace</button>
    </div>
    <div class="mark-hint" id="mark-hint">Ziehe ein Rechteck √ºber den Bereich den MIRA lesen soll.</div>
    <button id="mark-start-btn" onclick="startMarking()">‚¨ö Bereich markieren</button>
    <div class="cmd-hint" id="cmd-hint">MIRA klickt auf diese Position.</div>
    <div class="cmd-row">
      <button class="cmd-btn btn-skip" onclick="skipCmd()">√úberspringen</button>
      <button class="cmd-btn btn-save" onclick="saveCmd()">‚úì Speichern</button>
    </div>
  </div>
  <div id="done-block">
    <div class="done-icon">‚úÖ</div>
    <div class="done-title" id="done-title">Gespeichert!</div>
    <div class="done-sub"   id="done-sub">Schlie√üt...</div>
  </div>
  <div class="bottom-row" id="bottom-row">
    <button class="bot-btn bot-save"   onclick="earlySave()">‚úì Jetzt speichern</button>
    <button class="bot-btn bot-cancel" onclick="cancelRec()">‚úï Abbrechen</button>
  </div>
</div>

<div id="flash"></div>
<div id="mark-overlay"></div>
<div id="mark-rect"></div>




<script>
  const { ipcRenderer } = require('electron');

  let selType_    = 'click';
  let pendingStep = null;
  let pendingCoord = null;
  let selectedKey  = 'enter';
  let isMarking    = false;
  let markStart    = null;
  let markRegion   = null;
  let stepOffset   = 0;

  const HINTS = {
    click:   'MIRA klickt auf diese Position.',
    type:    'Was soll MIRA tippen?',
    extract: 'z.B. "extrahiere Rechnungsnummer, Summe, IBAN"',
    url:     'Welche URL √∂ffnen? z.B. https://gmail.com',
    key:     'Welche Taste? W√§hle unten aus.',
    mark:    'Markiere den Bereich den MIRA lesen soll.'
  };
  const PLACEHOLDERS = {
    click:   'Optional: z.B. klicke auf Suchfeld',
    type:    'z.B. https://youtube.com',
    extract: 'z.B. extrahiere Betrag, Datum, Rechnungsnummer',
    url:     'z.B. https://gmail.com',
    key:     '',
    mark:    'z.B. extrahiere Betrag, Datum, Rechnungsnummer'
  };

  function instrText(stepNum) {
    if (stepNum === 0) return { s:'START', m:'Gehe auf den Desktop', sub:'Minimiere alle Fenster ‚Üí <span class="kb y">0</span>' };
    const round = Math.floor((stepNum - 1) / 8) + 1;
    const local = ((stepNum - 1) % 8) + 1;
    return { s:`STEP ${stepNum}`, m:`Schritt ${stepNum} aufnehmen`, sub:`Maus auf Element ‚Üí <span class="kb g">${local}</span>${round > 1 ? ` <span style="color:rgba(255,255,255,0.2)">(Runde ${round})</span>` : ''}` };
  }

  function setInstr(stepNum) {
    const i = stepNum === 'done'
      ? { s:'FERTIG', m:'Alle Steps aufgenommen!', sub:'Klicke <b style="color:#34c759">‚úì Jetzt speichern</b>' }
      : instrText(stepNum);
    document.getElementById('instr-step').textContent = i.s;
    document.getElementById('instr-main').textContent = i.m;
    document.getElementById('instr-sub').innerHTML    = i.sub;
  }

  function setDot(id, cls) {
    const d = document.getElementById(`dot-${id}`);
    if (d) d.className = 'dot' + (cls ? ' ' + cls : '');
  }

  function flash() {
    const f = document.getElementById('flash');
    f.classList.remove('show');
    void f.offsetWidth;
    f.classList.add('show');
  }

  ipcRenderer.on('start-recording-overlay', (event, { name }) => {
    document.getElementById('route-name').textContent  = `"${name}"`;
    document.getElementById('done-block').classList.remove('show');
    document.getElementById('instr-block').style.display = 'block';
    document.getElementById('bottom-row').style.display  = 'flex';
    document.getElementById('btn-weiter').style.display  = 'none';
    document.getElementById('cmd-panel').classList.remove('show');
    stepOffset = 0;
    resetDots();
    setInstr(0);
  });

  ipcRenderer.on('show-cmd-panel', (event, { stepNum, coordinate }) => {
    pendingStep  = stepNum;
    pendingCoord = coordinate;
    document.getElementById('cmd-input').value = '';
    selType('click');
    setInstr(stepNum);
    openCmdPanel();
  });

  ipcRenderer.on('route-step-recorded', (event, { stepNum }) => {
    closeCmdPanel();
    flash();
    const localDot = ((stepNum - 1) % 8) + 1;
    setDot(localDot, 'done');
    const nextLocal = localDot + 1;
    if (nextLocal <= 8) {
      setDot(nextLocal, 'active');
      setInstr(stepNum + 1);
    } else {
      document.getElementById('btn-weiter').style.display = 'block';
      setInstr('done');
    }
  });

  ipcRenderer.on('route-record-done', (event, { name, steps }) => {
    closeCmdPanel();
    document.getElementById('instr-block').style.display  = 'none';
    document.getElementById('bottom-row').style.display   = 'none';
    document.getElementById('btn-weiter').style.display   = 'none';
    document.getElementById('done-block').classList.add('show');
    document.getElementById('done-title').textContent = `"${name}" gespeichert!`;
    document.getElementById('done-sub').textContent   = `${steps} Steps ¬∑ Schlie√üt...`;
    setTimeout(() => ipcRenderer.send('recording-cancelled'), 2200);
  });

  function weiterSteps() {
    stepOffset += 8;
    document.getElementById('btn-weiter').style.display = 'none';
    resetDots();
    setInstr(stepOffset + 1);
    ipcRenderer.send('recording-next-round', { offset: stepOffset });
  }

  function resetDots() {
    for (let i = 0; i <= 8; i++) setDot(i, i === 0 ? 'done' : '');
    setDot('save', 'save');
    setDot(1, 'active');
  }

  function openCmdPanel() {
    document.getElementById('cmd-panel').classList.add('show');
    setTimeout(() => document.getElementById('cmd-input').focus(), 50);
  }

  function closeCmdPanel() {
    document.getElementById('cmd-panel').classList.remove('show');
  }

  function selType(type) {
    selType_ = type;
    ['click','type','extract','url','key','mark'].forEach(t => {
      const el = document.getElementById(`type-${t}`);
      if (el) el.className = `type-btn${t === type ? ' t-' + t : ''}`;
    });
    document.getElementById('cmd-hint').textContent          = HINTS[type] || '';
    document.getElementById('cmd-input').placeholder         = PLACEHOLDERS[type] || '';
    document.getElementById('key-grid').style.display        = type === 'key'  ? 'grid'  : 'none';
    document.getElementById('cmd-input').style.display       = type === 'key'  ? 'none'  : 'block';
    document.getElementById('mark-hint').style.display       = type === 'mark' ? 'block' : 'none';
    document.getElementById('mark-start-btn').style.display  = type === 'mark' ? 'block' : 'none';
  }

  function selKey(key, e) {
    selectedKey = key;
    document.querySelectorAll('.key-btn').forEach(b => b.classList.remove('selected'));
    if (e && e.target) e.target.classList.add('selected');
  }

  function saveCmd() {
    let cmd, type;
    if (selType_ === 'key') {
      type = 'key';
      cmd  = selectedKey;
    } else if (selType_ === 'mark') {
      type = 'extract';
      cmd  = document.getElementById('cmd-input').value.trim() || 'extrahiere alle sichtbaren Daten';
      ipcRenderer.send('cmd-panel-result', {
        stepNum: pendingStep, coordinate: pendingCoord,
        type, command: cmd, mark_region: markRegion || null
      });
      closeCmdPanel();
      markRegion = null;
      return;
    } else {
      type = selType_;
      cmd  = document.getElementById('cmd-input').value.trim() || null;
    }
    ipcRenderer.send('cmd-panel-result', { stepNum: pendingStep, coordinate: pendingCoord, type, command: cmd });
    closeCmdPanel();
  }

  function skipCmd() {
    ipcRenderer.send('cmd-panel-result', { stepNum: pendingStep, coordinate: pendingCoord, type: 'click', command: null });
    closeCmdPanel();
  }

  function earlySave() { ipcRenderer.send('route-early-save'); }
  function cancelRec()  { ipcRenderer.send('recording-cancelled'); }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (isMarking) { stopMarking(); return; }
      cancelRec();
    }
    if (e.key === 'Enter' && !e.shiftKey && document.getElementById('cmd-panel').classList.contains('show')) {
      e.preventDefault();
      saveCmd();
    }
  });

  // ‚îÄ‚îÄ MARKIERUNG MIT SCROLL-SUPPORT ‚îÄ‚îÄ
  function startMarking() {
    isMarking  = true;
    markStart  = null;
    markRegion = null;

    const panel = document.getElementById('panel');
    panel.onmouseenter = null;
    panel.onmouseleave = null;

    document.getElementById('panel').style.display      = 'none';
    document.getElementById('bottom-row').style.display = 'none';
    document.body.style.overflow = 'hidden';

    const overlay = document.getElementById('mark-overlay');
    const rect    = document.getElementById('mark-rect');
    overlay.style.display = 'block';
    rect.style.display    = 'none';

    const hint = document.createElement('div');
    hint.id = 'mark-live-hint';
    hint.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);color:#ff375f;padding:8px 18px;border-radius:20px;font-size:13px;font-weight:700;z-index:99999;pointer-events:none;font-family:DM Sans,sans-serif;';
    hint.textContent = 'Ziehe Rechteck ¬∑ Mausrad = Scrollen w√§hrend Ziehen ¬∑ ESC = Abbrechen';
    document.body.appendChild(hint);

    ipcRenderer.send('overlay-release-mouse');

    // ‚îÄ‚îÄ Scroll-Tracking ‚îÄ‚îÄ
    let scrollOffset = 0;  // Gesamter Scroll in Pixel seit Markierung begann
    let isDragging   = false;
    let rectX = 0, rectY = 0, rectW = 0;

    overlay.onmousedown = (e) => {
      isDragging = true;
      markStart = { x: e.clientX, y: e.clientY };
      rectX = e.clientX;
      rectY = e.clientY;
      rectW = 0;
      rect.style.cssText = `display:block;position:fixed;left:${e.clientX}px;top:${e.clientY}px;width:0;height:0;border:2px solid #ff375f;background:rgba(255,55,95,0.1);pointer-events:none;z-index:99998;`;
    };

    overlay.onmousemove = (e) => {
      if (!markStart || !isDragging) return;
      rectX = Math.min(e.clientX, markStart.x);
      rectW = Math.abs(e.clientX - markStart.x);
      const h = Math.abs(e.clientY - markStart.y) + scrollOffset;
      rect.style.left   = rectX + 'px';
      rect.style.top    = markStart.y + 'px';
      rect.style.width  = rectW + 'px';
      rect.style.height = h + 'px';
    };

    // MAUSRAD ‚Äî scrollt den echten Bildschirm UND vergrossert das Rechteck
    overlay.onwheel = (e) => {
      e.preventDefault();
      if (!isDragging || !markStart) return;

      const SCROLL_PX = 60;  // Pixel pro Rad-Tick
      const direction = e.deltaY > 0 ? 'down' : 'up';

      // Echten Scroll via nut.js
      ipcRenderer.send('do-scroll', { direction, amount: 4 });

      if (direction === 'down') {
        scrollOffset += SCROLL_PX;
      } else {
        scrollOffset = Math.max(0, scrollOffset - SCROLL_PX);
      }

      // Rechteck-Hoehe aktualisieren
      const currentH = parseFloat(rect.style.height) || 0;
      const newH = direction === 'down'
        ? currentH + SCROLL_PX
        : Math.max(10, currentH - SCROLL_PX);
      rect.style.height = newH + 'px';
    };

    overlay.onmouseup = (e) => {
      if (!markStart || !isDragging) return;
      isDragging = false;
      const x = Math.min(e.clientX, markStart.x);
      const w = Math.abs(e.clientX - markStart.x);
      const h = Math.abs(e.clientY - markStart.y) + scrollOffset;
      markRegion = { x, y: markStart.y, width: w, height: h, scroll_offset: scrollOffset };
      scrollOffset = 0;
      stopMarking();
      document.getElementById('mark-hint').textContent = `‚úÖ ${Math.round(w)}√ó${Math.round(h)}px ‚Äî Befehl eingeben & Speichern!`;
    };
  }

  function stopMarking() {
    isMarking = false;
    document.body.style.overflow = '';
    const overlay = document.getElementById('mark-overlay');
    overlay.style.display  = 'none';
    overlay.onmousedown    = null;
    overlay.onmousemove    = null;
    overlay.onmouseup      = null;
    overlay.onwheel        = null;

    const lh = document.getElementById('mark-live-hint');
    if (lh) lh.remove();

    document.getElementById('panel').style.display      = 'block';
    document.getElementById('bottom-row').style.display = 'flex';
    document.getElementById('cmd-panel').classList.add('show');

    const panel = document.getElementById('panel');
    panel.onmouseenter = () => ipcRenderer.send('overlay-release-mouse');
    panel.onmouseleave = () => ipcRenderer.send('overlay-needs-mouse');

    
    ipcRenderer.send('overlay-release-mouse');
    setTimeout(() => document.getElementById('cmd-input').focus(), 100);
  }

  // ‚îÄ‚îÄ Drag Panel ‚îÄ‚îÄ
let dragging = false, ox = 0, oy = 0;
const panelEl = document.getElementById('panel');
const header  = document.querySelector('.panel-header');

header.style.cursor = 'grab';

header.addEventListener('mousedown', (e) => {
  dragging = true;
  ox = e.clientX - panelEl.offsetLeft;
  oy = e.clientY - panelEl.offsetTop;
  header.style.cursor = 'grabbing';
  ipcRenderer.send('overlay-release-mouse');
  e.stopPropagation();
});

document.addEventListener('mousemove', (e) => {
  if (!dragging) return;
  panelEl.style.left = (e.clientX - ox) + 'px';
  panelEl.style.top  = (e.clientY - oy) + 'px';
});

document.addEventListener('mouseup', () => {
  dragging = false;
  header.style.cursor = 'grab';
});

</script>
</body>
</html>