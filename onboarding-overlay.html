<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>MIRA â€” Willkommen</title>
<style>
  :root {
    --bg:      #0a0c14;
    --surface: #12151f;
    --border:  #1e2235;
    --text:    #e2e8f0;
    --text2:   #64748b;
    --accent:  #6c63ff;
    --accent2: #a78bfa;
    --green:   #34d399;
    --yellow:  #fbbf24;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body {
    width: 100%; height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    overflow: hidden;
    -webkit-font-smoothing: antialiased;
  }

  /* â”€â”€ Layout â”€â”€ */
  .screen {
    position: absolute; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 40px 48px;
    opacity: 0;
    transform: translateY(18px);
    transition: opacity .45s ease, transform .45s ease;
    pointer-events: none;
  }
  .screen.active {
    opacity: 1; transform: translateY(0);
    pointer-events: all;
  }
  .screen.exit {
    opacity: 0; transform: translateY(-18px);
    pointer-events: none;
  }

  /* â”€â”€ Step dots â”€â”€ */
  .dots {
    position: fixed; bottom: 28px; left: 0; right: 0;
    display: flex; justify-content: center; gap: 8px;
  }
  .dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--border); transition: background .3s, width .3s;
  }
  .dot.active { background: var(--accent); width: 20px; border-radius: 3px; }
  .dot.done   { background: var(--green); }

  /* â”€â”€ Typography â”€â”€ */
  .title {
    font-size: 26px; font-weight: 800;
    letter-spacing: -.5px; line-height: 1.2;
    text-align: center; margin-bottom: 10px;
  }
  .subtitle {
    font-size: 14px; color: var(--text2);
    text-align: center; line-height: 1.6;
    max-width: 360px; margin-bottom: 36px;
  }

  /* â”€â”€ MIRA Logo/Avatar â”€â”€ */
  .mira-ring {
    width: 88px; height: 88px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6c63ff 0%, #a78bfa 100%);
    display: flex; align-items: center; justify-content: center;
    font-size: 38px; margin-bottom: 28px;
    box-shadow: 0 0 0 0 rgba(108,99,255,.4);
    animation: pulse 2.8s infinite;
  }
  @keyframes pulse {
    0%   { box-shadow: 0 0 0 0 rgba(108,99,255,.4); }
    70%  { box-shadow: 0 0 0 22px rgba(108,99,255,0); }
    100% { box-shadow: 0 0 0 0 rgba(108,99,255,0); }
  }
  .mira-ring.scan { animation: spin-ring 3s linear infinite; }
  @keyframes spin-ring {
    from { box-shadow: 0 0 0 0 rgba(108,99,255,.5), 0 0 0 12px rgba(108,99,255,.15); }
    50%  { box-shadow: 0 0 0 14px rgba(108,99,255,.25), 0 0 0 26px rgba(108,99,255,.07); }
    to   { box-shadow: 0 0 0 0 rgba(108,99,255,.5), 0 0 0 12px rgba(108,99,255,.15); }
  }
  .mira-ring.done { background: linear-gradient(135deg, #34d399 0%, #6ee7b7 100%); animation: none; }

  /* â”€â”€ Buttons â”€â”€ */
  .btn {
    padding: 13px 36px; border-radius: 12px;
    font-size: 15px; font-weight: 700;
    cursor: pointer; border: none;
    transition: opacity .15s, transform .1s;
    letter-spacing: -.1px;
  }
  .btn:hover { opacity: .88; }
  .btn:active { transform: scale(.97); }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-ghost {
    background: none; color: var(--text2);
    border: 1px solid var(--border);
    padding: 10px 24px; font-size: 13px;
    font-weight: 600; border-radius: 10px;
    cursor: pointer; transition: color .15s;
  }
  .btn-ghost:hover { color: var(--text); }

  /* â”€â”€ App grid (scan) â”€â”€ */
  .app-grid {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 10px; width: 100%; max-width: 380px;
    margin-bottom: 32px;
  }
  .app-chip {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px 12px;
    display: flex; align-items: center; gap: 8px;
    font-size: 12px; font-weight: 600;
    opacity: 0; transform: scale(.9);
    transition: opacity .3s, transform .3s;
  }
  .app-chip.visible { opacity: 1; transform: scale(1); }
  .app-chip .icon { font-size: 18px; }

  /* â”€â”€ Questions â”€â”€ */
  .questions { width: 100%; max-width: 400px; }
  .q-label {
    font-size: 11px; font-weight: 700;
    color: var(--text2); text-transform: uppercase;
    letter-spacing: .6px; margin-bottom: 8px; display: block;
  }
  .q-row { margin-bottom: 18px; }
  .industry-grid {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  .industry-btn {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 12px;
    font-size: 12px; font-weight: 600;
    color: var(--text2); cursor: pointer;
    display: flex; align-items: center; gap: 7px;
    transition: border-color .15s, color .15s, background .15s;
    text-align: left;
  }
  .industry-btn:hover { border-color: var(--accent); color: var(--text); }
  .industry-btn.selected {
    border-color: var(--accent); color: var(--text);
    background: rgba(108,99,255,.12);
  }

  .task-chips { display: flex; flex-wrap: wrap; gap: 6px; }
  .task-chip {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px; padding: 6px 12px;
    font-size: 12px; font-weight: 600; color: var(--text2);
    cursor: pointer;
    transition: border-color .15s, color .15s, background .15s;
  }
  .task-chip:hover { border-color: var(--accent); color: var(--text); }
  .task-chip.selected {
    border-color: var(--accent); color: var(--accent);
    background: rgba(108,99,255,.12);
  }

  /* â”€â”€ Progress bar (generating) â”€â”€ */
  .progress-bar {
    width: 280px; height: 4px;
    background: var(--border); border-radius: 2px;
    overflow: hidden; margin-top: 28px;
  }
  .progress-fill {
    height: 100%; width: 0;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 2px;
    transition: width .6s ease;
  }
  .progress-label {
    font-size: 12px; color: var(--text2);
    text-align: center; margin-top: 12px;
    min-height: 18px;
  }

  /* â”€â”€ Ready checkmarks â”€â”€ */
  .ready-list { list-style: none; margin-bottom: 36px; text-align: left; }
  .ready-list li {
    display: flex; align-items: center; gap: 10px;
    font-size: 14px; padding: 5px 0;
    opacity: 0; transform: translateX(-10px);
    transition: opacity .35s, transform .35s;
  }
  .ready-list li.show { opacity: 1; transform: translateX(0); }
  .ready-list .check { color: var(--green); font-size: 16px; }

  /* â”€â”€ Scan animation text â”€â”€ */
  .scan-status {
    font-size: 12px; color: var(--text2);
    margin-bottom: 20px; min-height: 18px;
    text-align: center;
  }
</style>
</head>
<body>

<!-- â•â•â• STEP 0: AX PERMISSION â•â•â• -->
<div id="step-0" class="screen" style="display:none">
  <div class="mira-ring" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);animation:none">ğŸ”</div>
  <div class="title" style="font-size:20px">Zugriff benÃ¶tigt</div>
  <div class="subtitle">
    MIRA benÃ¶tigt Zugriff auf die <b>Bedienungshilfen</b>, um deine Apps zu steuern.<br><br>
    Systemeinstellungen wurden automatisch geÃ¶ffnet.<br>
    Aktiviere <b>MIRA Agent</b> in<br>Datenschutz &amp; Sicherheit â†’ Bedienungshilfen.
  </div>
  <button class="btn btn-primary" id="perm-check-btn" onclick="recheckPermission()">Ich habe es aktiviert âœ“</button>
  <div id="perm-status" style="font-size:12px;color:#f87171;margin-top:12px;min-height:18px"></div>
</div>

<!-- â•â•â• STEP 1: WELCOME â•â•â• -->
<div id="step-1" class="screen active">
  <div class="mira-ring">M</div>
  <div class="title">Hallo, ich bin MIRA.</div>
  <div class="subtitle">Deine digitale BÃ¼roassistentin. Ich lerne deinen Job kennen â€” damit du dich auf das Wesentliche konzentrieren kannst.</div>
  <button class="btn btn-primary" onclick="goTo(2)">Los geht's â†’</button>
</div>

<!-- â•â•â• STEP 2: SCAN â•â•â• -->
<div id="step-2" class="screen">
  <div class="mira-ring scan" id="scan-ring">ğŸ”</div>
  <div class="title" style="font-size:20px">Ich scanne dein Systemâ€¦</div>
  <div class="scan-status" id="scan-status">Suche nach installierten Appsâ€¦</div>
  <div class="app-grid" id="app-grid"></div>
  <button class="btn btn-primary" id="scan-next-btn" style="display:none" onclick="goTo(3)">Weiter â†’</button>
</div>

<!-- â•â•â• STEP 3: JOB SETUP â•â•â• -->
<div id="step-3" class="screen">
  <div class="title" style="font-size:20px;margin-bottom:6px">Was machst du tÃ¤glich?</div>
  <div class="subtitle" style="margin-bottom:20px">Keine langen Einstellungen. Nur 2 Fragen.</div>
  <div class="questions">

    <div class="q-row">
      <span class="q-label">Branche</span>
      <div class="industry-grid" id="industry-grid">
        <button class="industry-btn" data-v="handel"        onclick="selectIndustry(this)">ğŸ›’ Handel / E-Commerce</button>
        <button class="industry-btn" data-v="gastronomie"   onclick="selectIndustry(this)">ğŸ½ Gastronomie</button>
        <button class="industry-btn" data-v="buero"         onclick="selectIndustry(this)">ğŸ¢ BÃ¼ro / Verwaltung</button>
        <button class="industry-btn" data-v="it"            onclick="selectIndustry(this)">ğŸ’» IT / Freelancer</button>
        <button class="industry-btn" data-v="handwerk"      onclick="selectIndustry(this)">ğŸ”§ Handwerk / Bau</button>
        <button class="industry-btn" data-v="sonstige"      onclick="selectIndustry(this)">âœ¦ Sonstiges</button>
      </div>
    </div>

    <div class="q-row">
      <span class="q-label">Was machst du tÃ¤glich? (mehrfach wÃ¤hlbar)</span>
      <div class="task-chips" id="task-chips">
        <div class="task-chip" data-v="emails"       onclick="toggleTask(this)">ğŸ“§ E-Mails</div>
        <div class="task-chip" data-v="rechnungen"   onclick="toggleTask(this)">ğŸ§¾ Rechnungen</div>
        <div class="task-chip" data-v="bestellungen" onclick="toggleTask(this)">ğŸ“¦ Bestellungen</div>
        <div class="task-chip" data-v="berichte"     onclick="toggleTask(this)">ğŸ“Š Berichte</div>
        <div class="task-chip" data-v="kalender"     onclick="toggleTask(this)">ğŸ“… Termine</div>
        <div class="task-chip" data-v="dokumente"    onclick="toggleTask(this)">ğŸ“„ Dokumente</div>
        <div class="task-chip" data-v="buchhaltung"  onclick="toggleTask(this)">ğŸ’° Buchhaltung</div>
        <div class="task-chip" data-v="support"      onclick="toggleTask(this)">ğŸ§ Support</div>
      </div>
    </div>

  </div>
  <button class="btn btn-primary" id="setup-next-btn" style="margin-top:8px" onclick="goToGenerate()">MIRA einrichten â†’</button>
</div>

<!-- â•â•â• STEP 4: GENERATING â•â•â• -->
<div id="step-4" class="screen">
  <div class="mira-ring scan">âš™ï¸</div>
  <div class="title" style="font-size:20px">Ich lerne deinen Jobâ€¦</div>
  <div class="subtitle" style="margin-bottom:0">Einen Moment. Ich richte alles ein.</div>
  <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
  <div class="progress-label" id="progress-label">Analysiere gefundene Appsâ€¦</div>
</div>

<!-- â•â•â• STEP 5: READY â•â•â• -->
<div id="step-5" class="screen">
  <div class="mira-ring done">âœ“</div>
  <div class="title">Ich bin bereit.</div>
  <div class="subtitle" style="margin-bottom:20px">Ich kenne deinen Job. Ich fange an.</div>
  <ul class="ready-list" id="ready-list">
    <li><span class="check">âœ“</span> <span id="rl-apps">Apps erkannt</span></li>
    <li><span class="check">âœ“</span> <span id="rl-triggers">Trigger aktiviert</span></li>
    <li><span class="check">âœ“</span> <span id="rl-limits">Grenzen gesetzt</span></li>
    <li><span class="check">âœ“</span> Bereit fÃ¼r Aufgaben</li>
  </ul>
  <button class="btn btn-primary" onclick="finish()">Loslegen â†’</button>
</div>

<!-- â”€â”€ Step dots â”€â”€ -->
<div class="dots">
  <div class="dot active" id="dot-1"></div>
  <div class="dot"        id="dot-2"></div>
  <div class="dot"        id="dot-3"></div>
  <div class="dot"        id="dot-4"></div>
  <div class="dot"        id="dot-5"></div>
</div>

<script>
const { ipcRenderer } = require('electron');

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentStep = 1;
let scannedApps = [];
let selectedIndustry = '';
let selectedTasks    = new Set();

// â”€â”€ Step navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function goTo(n) {
  const prev = document.getElementById('step-' + currentStep);
  prev.classList.add('exit');
  setTimeout(() => prev.classList.remove('active', 'exit'), 450);

  currentStep = n;
  setTimeout(() => {
    const next = document.getElementById('step-' + n);
    next.classList.add('active');
    updateDots();
    if (n === 2) startScan();
  }, 80);
}

function updateDots() {
  for (let i = 1; i <= 5; i++) {
    const d = document.getElementById('dot-' + i);
    d.classList.remove('active', 'done');
    if (i < currentStep) d.classList.add('done');
    else if (i === currentStep) d.classList.add('active');
  }
}

// â”€â”€ Step 2: App Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function startScan() {
  const statusEl = document.getElementById('scan-status');
  const grid     = document.getElementById('app-grid');
  const ring     = document.getElementById('scan-ring');
  grid.innerHTML = '';

  statusEl.textContent = 'Suche nach installierten Appsâ€¦';
  await sleep(600);

  const result = await ipcRenderer.invoke('onboarding-scan-apps');
  scannedApps = result.apps || [];

  if (scannedApps.length === 0) {
    statusEl.textContent = 'Scan abgeschlossen.';
  } else {
    statusEl.textContent = `${scannedApps.length} Apps gefunden.`;
  }

  // Animate chips in
  for (const app of scannedApps) {
    const chip = document.createElement('div');
    chip.className = 'app-chip';
    chip.innerHTML = `<span class="icon">${app.icon}</span><span>${app.name}</span>`;
    grid.appendChild(chip);
  }
  // Staggered reveal
  const chips = grid.querySelectorAll('.app-chip');
  chips.forEach((c, i) => {
    setTimeout(() => c.classList.add('visible'), 120 + i * 80);
  });

  ring.textContent = 'âœ“';
  ring.classList.remove('scan');

  await sleep(300 + scannedApps.length * 80);
  document.getElementById('scan-next-btn').style.display = 'block';
}

// â”€â”€ Step 3: Industry / Tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function selectIndustry(btn) {
  document.querySelectorAll('.industry-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedIndustry = btn.dataset.v;
}

function toggleTask(chip) {
  chip.classList.toggle('selected');
  if (chip.classList.contains('selected')) selectedTasks.add(chip.dataset.v);
  else selectedTasks.delete(chip.dataset.v);
}

function goToGenerate() {
  if (!selectedIndustry) {
    document.getElementById('industry-grid').style.outline = '1px solid #f87171';
    setTimeout(() => document.getElementById('industry-grid').style.outline = '', 1500);
    return;
  }
  goTo(4);
  runGenerate();
}

// â”€â”€ Step 4: Generate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function runGenerate() {
  const fill  = document.getElementById('progress-fill');
  const label = document.getElementById('progress-label');

  const steps = [
    [10,  'Analysiere gefundene Appsâ€¦'],
    [30,  'Erkenne Arbeitsmusterâ€¦'],
    [55,  'Aktiviere Standard-Triggerâ€¦'],
    [75,  'Setze Autonomiegrenzenâ€¦'],
    [90,  'Speichere Wissensbaseâ€¦'],
    [100, 'Fertig!'],
  ];

  for (const [pct, msg] of steps) {
    fill.style.width = pct + '%';
    label.textContent = msg;
    await sleep(pct === 100 ? 400 : 700 + Math.random() * 300);
  }

  const result = await ipcRenderer.invoke('onboarding-complete', {
    industry: selectedIndustry,
    tasks:    [...selectedTasks],
    apps:     scannedApps,
  });

  // Populate ready screen summary
  document.getElementById('rl-apps').textContent =
    `${scannedApps.length} App${scannedApps.length !== 1 ? 's' : ''} erkannt`;
  document.getElementById('rl-triggers').textContent =
    `${result.triggerCount || 0} Trigger aktiviert`;
  document.getElementById('rl-limits').textContent =
    `${result.limitCount || 0} Autonomiegrenzen gesetzt`;

  await sleep(200);
  goTo(5);
  animateReadyList();
}

// â”€â”€ Step 5: Ready â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function animateReadyList() {
  const items = document.querySelectorAll('#ready-list li');
  items.forEach((li, i) => setTimeout(() => li.classList.add('show'), 200 + i * 180));
}

function finish() {
  ipcRenderer.invoke('onboarding-finish');
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function checkAndStart() {
  // On macOS: check AX permission first â€” if denied show blocking screen
  const { granted } = await ipcRenderer.invoke('check-ax-permission');
  if (!granted) {
    document.getElementById('step-1').classList.remove('active');
    const s0 = document.getElementById('step-0');
    s0.style.display = '';
    setTimeout(() => s0.classList.add('active'), 50);
  }
}

async function recheckPermission() {
  document.getElementById('perm-status').textContent = 'PrÃ¼feâ€¦';
  document.getElementById('perm-check-btn').disabled = true;
  await sleep(600);
  const { granted } = await ipcRenderer.invoke('check-ax-permission');
  if (granted) {
    const s0 = document.getElementById('step-0');
    s0.classList.add('exit');
    setTimeout(() => { s0.classList.remove('active', 'exit'); s0.style.display = 'none'; }, 450);
    currentStep = 0;
    setTimeout(() => goTo(1), 80);
  } else {
    document.getElementById('perm-status').textContent = 'Noch nicht aktiviert â€” bitte in Systemeinstellungen â†’ Bedienungshilfen freigeben.';
    document.getElementById('perm-check-btn').disabled = false;
  }
}

checkAndStart();
</script>
</body>
</html>
