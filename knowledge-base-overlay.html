<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MIRA Wissensbase</title>
<style>
  :root {
    --bg:       #0f1117;
    --surface:  #1a1d27;
    --surface2: #22263a;
    --border:   #2e3248;
    --border2:  #3a3f5c;
    --text:     #e2e8f0;
    --text2:    #8892a4;
    --accent:   #6c63ff;
    --green:    #34d399;
    --red:      #f87171;
    --yellow:   #fbbf24;
    --radius:   10px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    -webkit-app-region: drag;
  }
  /* â”€â”€ Header â”€â”€ */
  .header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px 20px 12px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .header-icon { font-size: 20px; }
  .header-title { font-size: 15px; font-weight: 700; letter-spacing: -.3px; }
  .header-sub   { font-size: 11px; color: var(--text2); }
  .header-close {
    margin-left: auto;
    background: none;
    border: none;
    color: var(--text2);
    font-size: 18px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    -webkit-app-region: no-drag;
  }
  .header-close:hover { background: var(--surface2); color: var(--text); }

  /* â”€â”€ Tabs â”€â”€ */
  .tabs {
    display: flex;
    gap: 2px;
    padding: 10px 20px 0;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    -webkit-app-region: no-drag;
  }
  .tab {
    padding: 8px 14px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text2);
    cursor: pointer;
    border-radius: 8px 8px 0 0;
    border: 1px solid transparent;
    border-bottom: none;
    background: none;
    transition: background .15s, color .15s;
  }
  .tab:hover { color: var(--text); background: var(--surface2); }
  .tab.active {
    color: var(--text);
    background: var(--bg);
    border-color: var(--border);
    border-bottom-color: var(--bg);
    margin-bottom: -1px;
    z-index: 1;
  }

  /* â”€â”€ Content â”€â”€ */
  .content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    -webkit-app-region: no-drag;
  }
  .pane { display: none; }
  .pane.active { display: block; }

  /* â”€â”€ Form elements â”€â”€ */
  label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    color: var(--text2);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: .5px;
  }
  input, textarea, select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 8px;
    color: var(--text);
    font-size: 13px;
    padding: 8px 12px;
    outline: none;
    transition: border-color .15s;
    font-family: inherit;
  }
  input:focus, textarea:focus, select:focus { border-color: var(--accent); }
  textarea { resize: vertical; min-height: 64px; }
  .form-row { margin-bottom: 14px; }
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  .form-grid3 {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
  }

  /* â”€â”€ Cards (list items) â”€â”€ */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    margin-bottom: 10px;
    position: relative;
  }
  .card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }
  .card-title { font-size: 13px; font-weight: 600; flex: 1; }
  .badge {
    font-size: 10px;
    font-weight: 700;
    padding: 2px 7px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: .4px;
  }
  .badge-chef      { background: rgba(108,99,255,.25); color: #a29bfe; }
  .badge-lieferant { background: rgba(251,191,36,.2);  color: #fbbf24; }
  .badge-kunde     { background: rgba(52,211,153,.2);  color: #34d399; }
  .badge-sonstige  { background: rgba(148,163,184,.15); color: #94a3b8; }
  .badge-auto      { background: rgba(52,211,153,.2);  color: #34d399; }
  .badge-manual    { background: rgba(248,113,113,.2); color: #f87171; }

  .card-actions { display: flex; gap: 6px; }
  .btn-icon {
    background: none;
    border: 1px solid var(--border2);
    border-radius: 6px;
    color: var(--text2);
    cursor: pointer;
    font-size: 13px;
    padding: 4px 8px;
    transition: background .15s, color .15s;
  }
  .btn-icon:hover { background: var(--surface2); color: var(--text); }
  .btn-icon.del:hover { border-color: var(--red); color: var(--red); }

  /* â”€â”€ Add button â”€â”€ */
  .btn-add {
    width: 100%;
    padding: 10px;
    border: 1px dashed var(--border2);
    border-radius: var(--radius);
    background: none;
    color: var(--text2);
    font-size: 13px;
    cursor: pointer;
    transition: border-color .15s, color .15s;
    margin-top: 4px;
  }
  .btn-add:hover { border-color: var(--accent); color: var(--accent); }

  /* â”€â”€ Footer â”€â”€ */
  .footer {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 20px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    flex-shrink: 0;
    -webkit-app-region: no-drag;
  }
  .btn {
    padding: 8px 18px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: opacity .15s;
  }
  .btn:hover { opacity: .85; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-secondary { background: var(--surface2); border: 1px solid var(--border2); color: var(--text); }
  .status { font-size: 12px; color: var(--text2); margin-left: auto; }
  .status.ok  { color: var(--green); }
  .status.err { color: var(--red); }

  /* â”€â”€ Modal / inline edit â”€â”€ */
  .modal-backdrop {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,.55);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  .modal-backdrop.open { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 20px;
    width: 420px;
    max-width: 90vw;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal-title { font-size: 14px; font-weight: 700; margin-bottom: 16px; }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }

  .section-title {
    font-size: 11px; font-weight: 700; color: var(--text2);
    text-transform: uppercase; letter-spacing: .8px;
    margin-bottom: 12px;
  }

  .empty-state { text-align: center; color: var(--text2); font-size: 13px; padding: 30px 0; }
</style>
</head>
<body>

<!-- â”€â”€ Header â”€â”€ -->
<div class="header">
  <div class="header-icon">ðŸ§ </div>
  <div>
    <div class="header-title">MIRA Wissensbase</div>
    <div class="header-sub">MIRAs konfigurierbares Gehirn</div>
  </div>
  <button class="header-close" onclick="closeWindow()">âœ•</button>
</div>

<!-- â”€â”€ Tabs â”€â”€ -->
<div class="tabs">
  <button class="tab active" onclick="switchTab('kontext')">âš™ Kontext</button>
  <button class="tab"        onclick="switchTab('trigger')">âš¡ Trigger</button>
  <button class="tab"        onclick="switchTab('kontakte')">ðŸ‘¥ Kontakte</button>
  <button class="tab"        onclick="switchTab('grenzen')">ðŸ›¡ Grenzen</button>
</div>

<!-- â”€â”€ Content â”€â”€ -->
<div class="content">

  <!-- KONTEXT -->
  <div id="pane-kontext" class="pane active">
    <div class="section-title">Unternehmen & Rolle</div>
    <div class="form-grid">
      <div class="form-row">
        <label>Unternehmensname</label>
        <input id="ctx-company" type="text" placeholder="z. B. MÃ¼ller GmbH">
      </div>
      <div class="form-row">
        <label>MIRAs Rolle</label>
        <input id="ctx-role" type="text" placeholder="z. B. Buchhaltungsassistentin">
      </div>
    </div>
    <div class="form-row">
      <label>Sprache</label>
      <select id="ctx-lang">
        <option value="de">Deutsch</option>
        <option value="en">English</option>
        <option value="fr">FranÃ§ais</option>
        <option value="es">EspaÃ±ol</option>
      </select>
    </div>
    <div class="form-row">
      <label>ZusÃ¤tzliche Hinweise fÃ¼r MIRA</label>
      <textarea id="ctx-notes" rows="4" placeholder="z. B. Rechnungen immer in EUR. Lieferanten per E-Mail bestÃ¤tigen. Keine Zahlungen Ã¼ber 5.000 â‚¬ ohne RÃ¼ckfrage."></textarea>
    </div>
  </div>

  <!-- TRIGGER -->
  <div id="pane-trigger" class="pane">
    <div class="section-title">Events â†’ Routen</div>
    <div id="trigger-list"></div>
    <button class="btn-add" onclick="openTriggerModal()">+ Trigger hinzufÃ¼gen</button>
  </div>

  <!-- KONTAKTE -->
  <div id="pane-kontakte" class="pane">
    <div class="section-title">Personen & Unternehmen</div>
    <div id="contact-list"></div>
    <button class="btn-add" onclick="openContactModal()">+ Kontakt hinzufÃ¼gen</button>
  </div>

  <!-- GRENZEN -->
  <div id="pane-grenzen" class="pane">
    <div class="section-title">Autonomiegrenzen</div>
    <div id="limit-list"></div>
    <button class="btn-add" onclick="openLimitModal()">+ Grenze hinzufÃ¼gen</button>
  </div>

</div>

<!-- â”€â”€ Footer â”€â”€ -->
<div class="footer">
  <button class="btn btn-secondary" onclick="loadKB()">â†º Neu laden</button>
  <button class="btn btn-primary"   onclick="saveKB()">ðŸ’¾ Speichern</button>
  <span id="status-msg" class="status"></span>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- MODALS                                         -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Trigger Modal -->
<div id="modal-trigger" class="modal-backdrop">
  <div class="modal">
    <div class="modal-title" id="trigger-modal-title">Trigger hinzufÃ¼gen</div>
    <input type="hidden" id="trigger-edit-idx" value="">
    <div class="form-row">
      <label>Event-Typ</label>
      <select id="t-event">
        <option value="new_mail">Neue E-Mail</option>
        <option value="new_invoice">Neue Rechnung</option>
        <option value="new_order">Neue Bestellung</option>
        <option value="schedule">Zeitplan (tÃ¤glich/wÃ¶chentlich)</option>
        <option value="file_created">Neue Datei</option>
        <option value="custom">Benutzerdefiniert</option>
      </select>
    </div>
    <div class="form-row">
      <label>Bedingung (Komma-getrennte StichwÃ¶rter, optional)</label>
      <input id="t-condition" type="text" placeholder="z. B. rechnung, invoice, zahlung">
    </div>
    <div class="form-grid">
      <div class="form-row">
        <label>Route-ID</label>
        <input id="t-route-id" type="text" placeholder="route_abc123">
      </div>
      <div class="form-row">
        <label>Route-Name (Anzeige)</label>
        <input id="t-route-name" type="text" placeholder="z. B. Rechnung buchen">
      </div>
    </div>
    <div class="form-grid">
      <div class="form-row">
        <label>PrioritÃ¤t (1 = hÃ¶chste)</label>
        <input id="t-priority" type="number" min="1" max="99" value="10">
      </div>
      <div class="form-row">
        <label>AusfÃ¼hrung</label>
        <select id="t-auto">
          <option value="true">Autonom</option>
          <option value="false">Erst fragen</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModals()">Abbrechen</button>
      <button class="btn btn-primary"   onclick="saveTrigger()">Speichern</button>
    </div>
  </div>
</div>

<!-- Contact Modal -->
<div id="modal-contact" class="modal-backdrop">
  <div class="modal">
    <div class="modal-title" id="contact-modal-title">Kontakt hinzufÃ¼gen</div>
    <input type="hidden" id="contact-edit-idx" value="">
    <div class="form-grid">
      <div class="form-row">
        <label>Name</label>
        <input id="c-name" type="text" placeholder="Max Mustermann">
      </div>
      <div class="form-row">
        <label>Rolle</label>
        <select id="c-role">
          <option value="chef">Chef / Vorgesetzter</option>
          <option value="lieferant">Lieferant</option>
          <option value="kunde">Kunde</option>
          <option value="kollege">Kollege</option>
          <option value="sonstige">Sonstige</option>
        </select>
      </div>
    </div>
    <div class="form-grid">
      <div class="form-row">
        <label>E-Mail</label>
        <input id="c-email" type="email" placeholder="max@firma.de">
      </div>
      <div class="form-row">
        <label>Telefon (optional)</label>
        <input id="c-phone" type="text" placeholder="+49 ...">
      </div>
    </div>
    <div class="form-row">
      <label>Notizen</label>
      <textarea id="c-notes" rows="2" placeholder="z. B. Zahlung immer bis Ende des Monats"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModals()">Abbrechen</button>
      <button class="btn btn-primary"   onclick="saveContact()">Speichern</button>
    </div>
  </div>
</div>

<!-- Limit Modal -->
<div id="modal-limit" class="modal-backdrop">
  <div class="modal">
    <div class="modal-title" id="limit-modal-title">Grenze hinzufÃ¼gen</div>
    <input type="hidden" id="limit-edit-idx" value="">
    <div class="form-row">
      <label>Aktion</label>
      <input id="l-action" type="text" placeholder="z. B. send_mail, approve_invoice, delete_file">
    </div>
    <div class="form-grid">
      <div class="form-row">
        <label>AusfÃ¼hrung</label>
        <select id="l-auto">
          <option value="true">Autonom</option>
          <option value="false">Eskalieren</option>
        </select>
      </div>
      <div class="form-row">
        <label>Grenzwert (optional, â‚¬)</label>
        <input id="l-threshold" type="number" placeholder="z. B. 500">
      </div>
    </div>
    <div class="form-row">
      <label>Eskalieren an (E-Mail oder Name)</label>
      <input id="l-escalate" type="text" placeholder="chef@firma.de">
    </div>
    <div class="form-row">
      <label>Notizen</label>
      <textarea id="l-notes" rows="2" placeholder="z. B. Rechnungen Ã¼ber 500 â‚¬ immer bestÃ¤tigen lassen"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModals()">Abbrechen</button>
      <button class="btn btn-primary"   onclick="saveLimit()">Speichern</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
const { ipcRenderer } = require('electron');

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let kb = {
  context:  { company_name: '', role: '', language: 'de', notes: '' },
  triggers: [],
  contacts: [],
  limits:   [],
};

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function init() {
  await loadKB();
}

// â”€â”€ IPC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadKB() {
  setStatus('LÃ¤dtâ€¦', '');
  try {
    const result = await ipcRenderer.invoke('kb-load');
    if (result.success) {
      kb = result.kb || kb;
      renderAll();
      setStatus('Geladen', 'ok');
    } else {
      setStatus('Fehler: ' + (result.error || '?'), 'err');
    }
  } catch (e) {
    setStatus('Verbindungsfehler', 'err');
  }
}

async function saveKB() {
  collectContext();
  setStatus('Speichertâ€¦', '');
  try {
    const result = await ipcRenderer.invoke('kb-save', kb);
    if (result.success) {
      setStatus('Gespeichert âœ“', 'ok');
    } else {
      setStatus('Fehler: ' + (result.error || '?'), 'err');
    }
  } catch (e) {
    setStatus('Fehler: ' + e.message, 'err');
  }
}

function closeWindow() {
  ipcRenderer.invoke('kb-close');
}

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.pane').forEach(p => p.classList.remove('active'));
  event.currentTarget.classList.add('active');
  document.getElementById('pane-' + name).classList.add('active');
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderAll() {
  // Kontext
  document.getElementById('ctx-company').value = kb.context?.company_name || '';
  document.getElementById('ctx-role').value    = kb.context?.role         || '';
  document.getElementById('ctx-lang').value    = kb.context?.language     || 'de';
  document.getElementById('ctx-notes').value   = kb.context?.notes        || '';

  renderTriggers();
  renderContacts();
  renderLimits();
}

function collectContext() {
  kb.context = {
    company_name: document.getElementById('ctx-company').value.trim(),
    role:         document.getElementById('ctx-role').value.trim(),
    language:     document.getElementById('ctx-lang').value,
    notes:        document.getElementById('ctx-notes').value.trim(),
  };
}

function renderTriggers() {
  const el = document.getElementById('trigger-list');
  if (!kb.triggers.length) {
    el.innerHTML = '<div class="empty-state">Keine Trigger konfiguriert.<br>Trigger verbinden Events mit MIRA-Routen.</div>';
    return;
  }
  el.innerHTML = kb.triggers.map((t, i) => `
    <div class="card">
      <div class="card-header">
        <div class="card-title">${escHtml(t.route_name || t.route_id || 'â€”')}</div>
        <span class="badge ${t.auto !== false ? 'badge-auto' : 'badge-manual'}">${t.auto !== false ? 'autonom' : 'fragen'}</span>
        <div class="card-actions">
          <button class="btn-icon" onclick="editTrigger(${i})">âœŽ</button>
          <button class="btn-icon del" onclick="deleteTrigger(${i})">âœ•</button>
        </div>
      </div>
      <div style="font-size:12px;color:var(--text2)">
        <b>Event:</b> ${escHtml(eventLabel(t.event))}
        ${t.condition ? `&nbsp;Â·&nbsp;<b>Wenn:</b> ${escHtml(t.condition)}` : ''}
        &nbsp;Â·&nbsp;<b>Route:</b> <code style="font-size:11px">${escHtml(t.route_id || 'â€”')}</code>
        &nbsp;Â·&nbsp;<b>PrioritÃ¤t:</b> ${t.priority ?? 10}
      </div>
    </div>
  `).join('');
}

function renderContacts() {
  const el = document.getElementById('contact-list');
  if (!kb.contacts.length) {
    el.innerHTML = '<div class="empty-state">Keine Kontakte gespeichert.<br>MIRA nutzt Kontakte beim Klassifizieren von Mails.</div>';
    return;
  }
  el.innerHTML = kb.contacts.map((c, i) => `
    <div class="card">
      <div class="card-header">
        <div class="card-title">${escHtml(c.name || 'â€”')}</div>
        <span class="badge badge-${c.role || 'sonstige'}">${escHtml(roldeLabel(c.role))}</span>
        <div class="card-actions">
          <button class="btn-icon" onclick="editContact(${i})">âœŽ</button>
          <button class="btn-icon del" onclick="deleteContact(${i})">âœ•</button>
        </div>
      </div>
      <div style="font-size:12px;color:var(--text2)">
        ${c.email ? escHtml(c.email) : ''}${c.phone ? ' Â· ' + escHtml(c.phone) : ''}
        ${c.notes ? '<br>' + escHtml(c.notes) : ''}
      </div>
    </div>
  `).join('');
}

function renderLimits() {
  const el = document.getElementById('limit-list');
  if (!kb.limits.length) {
    el.innerHTML = '<div class="empty-state">Keine Grenzen definiert.<br>Grenzen bestimmen, wann MIRA eskaliert statt selbst handelt.</div>';
    return;
  }
  el.innerHTML = kb.limits.map((l, i) => `
    <div class="card">
      <div class="card-header">
        <div class="card-title">${escHtml(l.action || 'â€”')}</div>
        <span class="badge ${l.autonomous !== false ? 'badge-auto' : 'badge-manual'}">${l.autonomous !== false ? 'autonom' : 'eskalieren'}</span>
        <div class="card-actions">
          <button class="btn-icon" onclick="editLimit(${i})">âœŽ</button>
          <button class="btn-icon del" onclick="deleteLimit(${i})">âœ•</button>
        </div>
      </div>
      <div style="font-size:12px;color:var(--text2)">
        ${l.threshold ? `Max. <b>${escHtml(String(l.threshold))} â‚¬</b>&nbsp;Â·&nbsp;` : ''}
        ${l.escalate_to ? `Eskalieren an: ${escHtml(l.escalate_to)}&nbsp;Â·&nbsp;` : ''}
        ${l.notes ? escHtml(l.notes) : ''}
      </div>
    </div>
  `).join('');
}

// â”€â”€ Trigger CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openTriggerModal(idx) {
  const editing = idx !== undefined;
  document.getElementById('trigger-modal-title').textContent = editing ? 'Trigger bearbeiten' : 'Trigger hinzufÃ¼gen';
  document.getElementById('trigger-edit-idx').value = editing ? String(idx) : '';
  const t = editing ? kb.triggers[idx] : {};
  document.getElementById('t-event').value      = t.event      || 'new_mail';
  document.getElementById('t-condition').value  = t.condition  || '';
  document.getElementById('t-route-id').value   = t.route_id   || '';
  document.getElementById('t-route-name').value = t.route_name || '';
  document.getElementById('t-priority').value   = t.priority   ?? 10;
  document.getElementById('t-auto').value        = String(t.auto !== false);
  document.getElementById('modal-trigger').classList.add('open');
}

function editTrigger(idx)   { openTriggerModal(idx); }
function deleteTrigger(idx) { kb.triggers.splice(idx, 1); renderTriggers(); }

function saveTrigger() {
  const idxStr = document.getElementById('trigger-edit-idx').value;
  const t = {
    id:         idxStr ? kb.triggers[+idxStr]?.id : uid(),
    event:      document.getElementById('t-event').value,
    condition:  document.getElementById('t-condition').value.trim(),
    route_id:   document.getElementById('t-route-id').value.trim(),
    route_name: document.getElementById('t-route-name').value.trim(),
    priority:   parseInt(document.getElementById('t-priority').value) || 10,
    auto:       document.getElementById('t-auto').value === 'true',
  };
  if (!t.route_id) return alert('Route-ID ist Pflicht');
  if (idxStr !== '') kb.triggers[+idxStr] = t;
  else kb.triggers.push(t);
  closeModals();
  renderTriggers();
}

// â”€â”€ Contact CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openContactModal(idx) {
  const editing = idx !== undefined;
  document.getElementById('contact-modal-title').textContent = editing ? 'Kontakt bearbeiten' : 'Kontakt hinzufÃ¼gen';
  document.getElementById('contact-edit-idx').value = editing ? String(idx) : '';
  const c = editing ? kb.contacts[idx] : {};
  document.getElementById('c-name').value  = c.name  || '';
  document.getElementById('c-role').value  = c.role  || 'sonstige';
  document.getElementById('c-email').value = c.email || '';
  document.getElementById('c-phone').value = c.phone || '';
  document.getElementById('c-notes').value = c.notes || '';
  document.getElementById('modal-contact').classList.add('open');
}

function editContact(idx)   { openContactModal(idx); }
function deleteContact(idx) { kb.contacts.splice(idx, 1); renderContacts(); }

function saveContact() {
  const idxStr = document.getElementById('contact-edit-idx').value;
  const c = {
    id:    idxStr ? kb.contacts[+idxStr]?.id : uid(),
    name:  document.getElementById('c-name').value.trim(),
    role:  document.getElementById('c-role').value,
    email: document.getElementById('c-email').value.trim(),
    phone: document.getElementById('c-phone').value.trim(),
    notes: document.getElementById('c-notes').value.trim(),
  };
  if (!c.name) return alert('Name ist Pflicht');
  if (idxStr !== '') kb.contacts[+idxStr] = c;
  else kb.contacts.push(c);
  closeModals();
  renderContacts();
}

// â”€â”€ Limit CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openLimitModal(idx) {
  const editing = idx !== undefined;
  document.getElementById('limit-modal-title').textContent = editing ? 'Grenze bearbeiten' : 'Grenze hinzufÃ¼gen';
  document.getElementById('limit-edit-idx').value = editing ? String(idx) : '';
  const l = editing ? kb.limits[idx] : {};
  document.getElementById('l-action').value    = l.action    || '';
  document.getElementById('l-auto').value      = String(l.autonomous !== false);
  document.getElementById('l-threshold').value = l.threshold || '';
  document.getElementById('l-escalate').value  = l.escalate_to || '';
  document.getElementById('l-notes').value     = l.notes || '';
  document.getElementById('modal-limit').classList.add('open');
}

function editLimit(idx)   { openLimitModal(idx); }
function deleteLimit(idx) { kb.limits.splice(idx, 1); renderLimits(); }

function saveLimit() {
  const idxStr = document.getElementById('limit-edit-idx').value;
  const l = {
    id:          idxStr ? kb.limits[+idxStr]?.id : uid(),
    action:      document.getElementById('l-action').value.trim(),
    autonomous:  document.getElementById('l-auto').value === 'true',
    threshold:   document.getElementById('l-threshold').value.trim() || null,
    escalate_to: document.getElementById('l-escalate').value.trim(),
    notes:       document.getElementById('l-notes').value.trim(),
  };
  if (!l.action) return alert('Aktion ist Pflicht');
  if (idxStr !== '') kb.limits[+idxStr] = l;
  else kb.limits.push(l);
  closeModals();
  renderLimits();
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function closeModals() {
  document.querySelectorAll('.modal-backdrop').forEach(m => m.classList.remove('open'));
}

// Close modal on backdrop click
document.querySelectorAll('.modal-backdrop').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) closeModals(); });
});

function setStatus(msg, type) {
  const el = document.getElementById('status-msg');
  el.textContent = msg;
  el.className = 'status ' + (type || '');
  if (type === 'ok') setTimeout(() => { if (el.textContent === msg) el.textContent = ''; }, 3000);
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function uid() {
  return Math.random().toString(36).slice(2, 10);
}

function eventLabel(e) {
  const map = {
    new_mail:     'Neue E-Mail',
    new_invoice:  'Neue Rechnung',
    new_order:    'Neue Bestellung',
    schedule:     'Zeitplan',
    file_created: 'Neue Datei',
    custom:       'Benutzerdefiniert',
  };
  return map[e] || e;
}

function roldeLabel(r) {
  const map = { chef: 'Chef', lieferant: 'Lieferant', kunde: 'Kunde', kollege: 'Kollege', sonstige: 'Sonstige' };
  return map[r] || r || 'Sonstige';
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
